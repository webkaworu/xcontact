# システム全体のフロー

このドキュメントは、ユーザー登録から問い合わせ管理まで含めたシステム全体のフローを説明します。
フローは大きく分けて**「1. 設定フロー」**、**「2. 実行フロー」**、**「3. 管理フロー」**の3つのステージに分かれます。

---

### 【ステージ1: 設定フロー】
（主にシステム管理者と一般ユーザーが操作）

1.  **ユーザー登録・ログイン**
    *   まず、システムの利用者（管理者または一般ユーザー）がアカウントを登録し、ログインします。これにより、以降の操作を行うための認証トークンが発行されます。

2.  **問い合わせフォームの作成**
    *   ログインしたユーザーは、新しい問い合わせフォームを作成します。
    *   このとき、一般ユーザーの場合は「フォーム作成数の上限（デフォルト10件）」を超えていないかがチェックされます。

3.  **フォームの詳細設定**
    *   作成したフォームに対し、ユーザーは様々な設定を行います。
        *   **通知先:** 問い合わせがあった際に通知を受け取るメールアドレスを設定します。
        *   **流量制限:** 問い合わせを1日に何件、1ヶ月に何件まで受け付けるかを設定します（例: 1日5件まで）。
        *   **自動返信:** 問い合わせてきた人への自動返信メールを送るかどうか、どのテンプレートを使うかを設定します。

4.  **アクセストークンの発行**
    *   ユーザーは、このフォーム専用の「アクセストークン」を発行します。これは、外部のウェブサイトから安全に問い合わせを受け付けるための「鍵」の役割を果たします。

5.  **ウェブサイトへの設置**
    *   最後に、ユーザーは発行された「受付URL (`/submit/{発行されたトークン}`)」をコピーし、ホームページビルダーなどで作成した外部サイトのHTMLフォームの `action` 属性に設定します。これで準備は完了です。

---

### 【ステージ2: 実行フロー】
（主にウェブサイト訪問者が操作）

6.  **問い合わせの実行**
    *   ウェブサイトを訪れたエンドユーザーが、設置されたフォームに名前やメッセージなどを入力し、送信ボタンを押します。

7.  **バックエンドでの処理**
    *   ブラウザは、フォームの `action` に設定された受付URLに、入力された内容を送信します。
    *   本システムはリクエストを受け取り、アクセストークンが有効か、流量制限に達していないかなどを瞬時に検証します。
    *   検証を通過すると、問い合わせ内容をデータベースに保存し、**メール送信のジョブをキューに登録**して、すぐに「送信完了」の応答を返します。
    *   バックグラウンドで、キューに登録されたメール送信処理（管理者への通知・ユーザーへの自動返信）が実行されます。

---

### 【ステージ3: 管理フロー】
（主にシステム管理者と一般ユーザーが操作）

8.  **問い合わせ履歴の閲覧**
    *   フォームを作成した一般ユーザーは、ログイン後に自分が作成したフォームの問い合わせ履歴のみを閲覧できます。
    *   システム管理者は、すべてのフォームの全履歴を横断的に閲覧・検索できます。

9.  **ユーザーと権限の管理（管理者のみ）**
    *   システム管理者は、管理画面（API経由）でユーザーの一覧を閲覧します。
    *   特定の一般ユーザーに対し、「フォーム作成数の上限」を変更したり、「メールテンプレートの編集」といった追加の操作権限を与えたりすることができます。
